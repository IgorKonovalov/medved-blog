---
import { getCollection, render } from 'astro:content';
import BlogPostLayout from '../../layouts/BlogPostLayout.astro';
import { getReadingTime } from '../../utils/readingTime';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog');
  const sortedPosts = allPosts
    .filter((p) => !p.data.draft)
    .sort((a, b) => a.data.date.getTime() - b.data.date.getTime());

  return allPosts.map((entry) => {
    const sortedIndex = sortedPosts.findIndex((p) => p.id === entry.id);
    const prevPost = sortedIndex > 0 ? sortedPosts[sortedIndex - 1] : null;
    const nextPost = sortedIndex < sortedPosts.length - 1 ? sortedPosts[sortedIndex + 1] : null;

    return {
      params: { slug: entry.id },
      props: {
        entry,
        prevPost: prevPost ? { title: prevPost.data.title, slug: prevPost.id } : null,
        nextPost: nextPost ? { title: nextPost.data.title, slug: nextPost.id } : null,
      },
    };
  });
}

const { entry, prevPost, nextPost } = Astro.props;
const { Content } = await render(entry);
const readingTime = entry.body ? getReadingTime(entry.body) : 1;
---

<BlogPostLayout
  title={entry.data.title}
  description={entry.data.description}
  date={entry.data.date}
  updated={entry.data.updated}
  tags={entry.data.tags}
  image={entry.data.image}
  imageAlt={entry.data.imageAlt}
  readingTime={readingTime}
  prevPost={prevPost}
  nextPost={nextPost}
>
  <Content />
</BlogPostLayout>
